<?php

ini_set('memory_limit', '512M');
require_once "../vendor/autoload.php";
use Illuminate\Support\Collection;
function collect($value = null) { return new Collection($value); }

$input = "
#..##...#...####.......#...###.#...#.##.#.#.###.##...#..#.....#..#.##..#.....#...###.......###.###...##..##.#.##.#.#.......##.#.#..#.#...##....#..#.###...#......#..##...##.#.##.##.###.##.#...#..###...###..###.##.#..#..#.#.#..########..#.#.#.####....##.##.#.##.##.#...#..###...###.###..#...##.##..###.##.##.#.###.#...#####.##.####.####.##...####.####...#.#.##..#.######.#..#...##.#.##..###.##.#..##.##....##.###.###..#..##.#.#...##.#.#####...##....#.##....####.#.####.#####.#....#...###.....#####.#...###..#.####.

.##...##..####.##.##.#...######.#.#..#.#.#..#.#.#.##....##.#..#..#..####.#..########.##.###.#.##.###
####.....##.#...#.###...#.##.......##.#...#######.......#..#..#...#.#.....##.#.##.####.....#.###.#..
........#.###.#..#####..#.##.###.#..#..#.#..##..#...#...#.....##..##.....##.#####.#..##.#..#.###...#
..#.#.#.####...........#...#.........#####.#.######..#...##..#.##.#..#.....###.##.##.......####.###.
..#.....###..#.####...#########.....#.#.####..##..###..####.#.##..####.#.###.##......#..#.#.#.#.....
.#......#.....#..########.####....##....##..#...###...#.#####...#.#...#.#........##########.##.##.##
###..###.#.###....###.....##....##.#....###..#....###....####.##..#...#....########.##.#.#.#.......#
#..####..######.#.###..###...#......#######..#..##.######..##.#####......###...#.#.##..##.##.#.#..#.
#....###.#.##...##..#.######..#.##..##..###.##....#.#.#....#..####..#....#.#...##.##.....###.##..###
.##.###..#..###..##.....#.#....##.###.#..#..##..######..##.##..##...#.###.#.#...#.####..#..#..###.#.
###..#.##..##.#.#......#####....##..##.#.#.#.##...#.##..###....##..###...#...###.########..#.#..###.
.#...#.###..##..#..##.....##...#.#...##.#.###.##.#..#.#.#.###..#.###....##.....##...######....#.##.#
#####..#####..##.#......#.#..#...#.##.##.#.....#.##.#..###.###.##..###.###.#......###.##..#.....#..#
#.###..##..###..#..#..#.#..##.#.##.#..#....#..#....#.######..###.##....###.##..#.#..##.....#####.#.#
...#..#..##...#.####.###.....#...##.#.#.####.#...###....#..##...#......#######..##..##..#...#..#.###
...##.#.#######.#.#.#..#.####.##.##..###..#####.###..#.....##......#####.#.....##..##.#...###.##.###
#.#...#.#.#.#....##.##...#...#.....#..###.##..#.#.#..#.##..#..#######.#.....###.######...#######..##
##.#.#.#..##...#.##.#.#..#...#.#.####.##.##..#.#.#.#...##.##..#....###..####.#..#.#....#....#######.
#.....##....##.......##..#.##.#..#.##.....##.#.......##.###.###.#.##.#..#..#.#....####..#####.#.#.#.
#..#...##..###......#.##....#.###..####.#..##..##.#.##.#.##.#..########....####.##.#######.##.######
###...#####...#.###.#.#..#....#..#..#.....##.#.##.#...#.###.#.....##....#.##.#...###.#...#.#..#.#...
##..##...##..#.###.###..#..####..#...##.#.#.###.###..#####.##..##.#.##..###..#######.##....#.##.#..#
.##..#...#####.####..###.#..###..##..#..#.##..#........#..###..#.#....#.#....##...#.#.####....#.##.#
#...#.#.#####...##..####.###.#..#.##.#...#..##........#.#####...#####....###.#...#.##.######.##.#...
#..#..#.#.#####.##.##.#..######..##.#######.#.#..#..#.......#..#.####.#...##..###..#####.###.#...#..
..#.#.##.#.......#.#.#.#.##.##.#.#####..#.....####..#....#.#..########.#.#....#....#.####.#####.#.##
#######.###..#...#####...#####...#.#.####.#......##.#..##.###.####..##..#######..#.##.####..###.##..
#..#....#.#..##.####.#..#.######......#.##..##...##........###.########..##.#####.#..#..######.#..##
#######.###########..##...#.#....#.###..#..#...#..#.....#.##.##..#.#.....#..######.####..#.#.#....#.
#.###.###...##.#..##....##..#..###..#...#.##.####.#####.#.#######.#.#....#....#...#.##...##..#..#...
.#.####..#####..##....##.#.....#####..##.#.....#..#...##.##..#.######....#..##.######....#.#..###.#.
#..##.#.##..##.#.....##.#...#.##.#######.###.###.##.#...#.##..#####...###.##.###.##.##..###.#..#..##
#.#.#.#.....###...#.###...##.#..#..##...#.#....#.#.#.#.#.##.......#.#####........#######..##.#.....#
#.#...#.#.##..#.##....#.##.#.#..###.#...#..#...###.##...#...###...###..###.#.#..##.#.#.#.##.#.###.#.
..#...#.#.#.#######...###.#.#...#..###...#.####..#..##..#.##......#...##..##.##..#...##....##..#....
..#.##.##.#..##...#.#.#..##..###.#..####.#...#....#..##.#.#.....###.#.#...#.#.#.#.#..###.#.#.#.##.##
...#...#.#...###..##..##.#......#.....###..####...#.#####.###.##..#.#..#...###..#..#..#.#.##..###.##
..#..##.#..##.#.#....#..##.#......#.##.#....#......#..#...##.###.###.#######.##.###..##.#.###...#...
###..##..###.#.##....##.#####.####.#....#.##....###..###.#......#.##.##..#....#..#..##.##...#...#..#
.####.###.#..#####..#.####.#...##.#...##.##.....#.#.##.####.#...##...####..#..#####.####.#.........#
##....#..#.#..#...#.###.#.##....#.##...#.#...###.##.#..#..#...#.###.###..#########.#..#..#...#...##.
....#.#...###..#.##..#..###.##.#.#...##...##.#######..#.#..#..#...##.#..#..#.#.#...##..##....#....#.
##.###...###.#...##.....#.#..####....#.##.....##.#.#...####...###..#...##...##...#.#.#...##.##..###.
##.##.####.#.##..###.#.#....##.##.###.#.#..##.###..##.#...#..#.#......#.#..#...##...#.####.#####...#
.#...#####.########.#..##.#####.#...##.........####.####.##.#.#.#.#..##..#..##..#...###.###.##..#.##
..###.##...#..#..#####.##.######.#..######.#######.#..##..###.###......#.###.######...####...##..###
#.##..########....#......#...#...###.#.###.....#.#####.####.##...##.##...#.###..#.########.#......#.
#.######..#..####.#.#....##....#.#...##..##..###..#####.#.#.....#####.#.#.#.#...#..#...#####.#......
#.....#.##.......#...#.#..##.#########.###.#.#.#.##.#..####...#.####.###...#.#.....#.#####.#..#.###.
##.#.#...##.##..#.....###..#....###.#..#.#...#..#.##.##.#....#.####.#.#...##...##.....###..###..#..#
.#.##....#..####...##.###...#..#...#.#..#..#.##.##...#.#...#..#.#####.###.##.........####..##.##.#.#
#.#.####.#.#..#.#..##....#.##.#.#.####..#......#.##....###.###.#...##..#..#..######..#.#..#....#.#..
.####...###.##.##.#.#.#.##.#.....#..##.#.###.#.##...#.#.#..#.############..##.#.#...#...###.#..###.#
..##.#..#.##.#.#.##.#......###..#....##.##..##.#....####.####..#.#.#.##.#...#.#...##..##.##..#..#.#.
###..#..#########.##.#.#.##...###...#..#...##.#.#.#.###..##...###.##....#..######...##.#.#..###.#..#
.#####...##.##.##.#.#.####.#.##.###..##.###.###....####..###.#.####..##.####...#.#......##.#...#####
##.##..#..#.####.....###.#....#..######.##..###..#.#.##..#.#.####.....##..#####.#.#####.####..#.#.##
#....##.#.......##.#.#...##..#..#...##.#.#.#..###....#..#..##.#.#.#..#..##....####.###..##.#.##.#.##
########.##.#.##.##.###....##.#..##.#####...###..####.#...##....#..#..#....#.##...##.#.#.####.#....#
.######..#...#.........#..#...#.#..###...#.##.##.#....##..#.##.##..#.####.#..#####.###...#..#......#
##.######..######.##...#....####...#..#.##.#..#..#..#.#..##.#..###.#.##..#..#.##.###.#...##..##..#..
##..#####...##.#..#...###.#...##.#####.##..#.....##.#.#.##.#.#.....###.....##.##...##..#..##.##.####
#.##.#.#..#....#.##...##.####.##....#.##.#.##.....#.##....####.##...##..#.##.##..#.#.##.#.####.##.##
...#...#.###......###...#..######.######.##.##.###.#..#...#..#.#.#.#.#.#..###...#...##..###...#.#.#.
..#.#.##.#...###.#.##.###....#......#.#.###.####.###..#.#..#.#..###..#.##...#######.###..#.#.##.....
..#..###...#.##.....#..#...#.#..######.#######..#.###.##.#...###..#..#.##....#..##......#.#.#...#.##
#......####...#...###..#...#.#....####..#.#..........####.###....##.#.##.....#....##..#..#....####.#
.####...#.##......#####.###........#######.#.##..###.#.......####.##.##.##.....#...#....###..#..##.#
....#.####..#.....##.#..#.##...####.#.....#.##.#...#..####....#.#.#.##.#...###.#..#...#######...#.##
##.####...#.#.#.###.#.###...#.....#.#.....#.#.#.##..#....###....##..#.#.###..#.#....#..##....##..#..
.#....#.#.##..####..######.##......#.##...#.##..##....##..##....##.######.#.##.#...##.#...#.##.##...
..##.##.#..####.##.###..#.#.###..#...#..#..##..###.#.....#.......#..#...##..#.###...###...#..##.#.#.
.#.##.#.#.##.#.#....####.##.###.##...########....#.###....#.##..#.#...#..##.###...#.#..##.......###.
#..#..#.#.#.#.....####.###.....##..#.####...###..##..##..###.#.##....#..#.##.###..##...#####.##.##..
###.#..#.##.##...########..#..#...###.##..#.#.#..#.####.###.###.#.#.##..###...######.###.#.....##...
..#.##.##..##.#.###...#..##...#.......####.......###........##.##......#.#.#.#..#.####.##....#.##...
#.####.#.#.###.#####.##...#..#.#...#....###..##..######.##.#.#.....#.....##....#..#......###.####...
##.##........#.##.##.#####.###.#....#....######.#.######........##...##.####.#...##...############..
#.#.##.#.###.###.##..##.#.##...#####...##.##.#....###.#..###.#.#.#.#.#..#..#......####.........##...
#......##.###.#..#.....#.#.#..##..##..#..#.#####....###.#.#..#...#..#.#.##.##.##.#...#....#.#.#.#.#.
...##...##.##########..#...####...#.#.##..##....#.#.#..##.#..#....##.####..#.#######.####...##.#....
#.###..#####..##.#.#..###.#.#.#..##..##.####.###.#.#..#.##.#####.#.#########.##.###...########..#..#
.##.####.#....##...##.####..#....#..###..##...#.#.###........###.##########..##.....#.######.#.##...
..###.#..#.###.####...#####...##.###.###.....#....####..###.#...##.####.#.##.##.#..#..###.#...#.#...
#.#...#...#..#..#...##.###.###..#.####...##.##.#.......###.###.#...#....#.#..#.#.#.###....#...#.#.#.
###.##.#..######..##..#.#..#####...#...#.##.#..##...#######......##.######...#.#.#.#######.####....#
#..#.#######..#..#####...#.....#..#..##.#...#...#.##..#####.....##..############.##.###.##.#.####.##
#.##.#...#...#....##.....###.#.#..#.#..##....##.##.#.###..#.###.##.#..#####.#.#######...###..#..#.##
##.#.....#.#.#..###..#..####..#..##.#.#....#.#..##...#..#..##..#.#.#..##.#.##...##...#####..#.#.##.#
.##....###....##.#.#.##.####...#...###...#..#.#.##..#####........#...#..#.##.##.#..#....#..#.#.#.#.#
.#######.#.##..#.##.#####.#######.#.#......#..#..#..##..##.#...##.##....#......#...#.#...###....###.
....###.#..###...#...#.#..#.####.##....#....#####..###..#..###.#....#.#.#.#.#####...#.#...##.###....
..##.######..#.#.###.########.##.####..##..#.#.....###.#.#.####.#...#.#..#####.##..#..#.###....#..#.
.##.#...###.....#..#.#...#####.#.#.####.....#.....###.#.####.#####...#..##.##########.#.##########..
.###..#.#.######.#.##.#.####.#.#.##.#.##.####.##..#...##..#######.........##..#.#....##.#.#######.#.
##.##.##..#...#.###.#...####..##..####.#.#.##.##.#....####.####....#.#..###.##.##....#####..#.##.#.#
#........#.##.#...#.##.....#.###.#..##.##..#..##..#.....###.#.#.#.##.###..#.#.....#..#.#.#.###.#.###
####.#.#####......#.##..#.####.#.....##.######..#..#..#.##..#.#.#..#..####...#.#...#.##.......#....#
##.#.##..#..####.#.#..#..#.##...#.#.#.#...#.#.#.#.#..#.....###.#...#.....#...###....###.##..#.#.#..#
.####.....#...##..##.####.#.#.###......##.###...#..#..###.##..##.##...##...###.....#..##.##.#.###...
";

function bin2image($binstring) { return str_replace("1", "#", str_replace("0", ".", $binstring)); }
function image2bin($binstring) { return str_replace("#", "1", str_replace(".", "0", $binstring)); }
function printimg($img) {
  foreach ($img as $line) {
    foreach ($line as $char) {
      echo $char === "1" ? "#" : ".";
    }
    echo "\n";
  }
}
function lit($img) {
  return array_sum(
    array_map(
      fn($row) => array_sum(
        array_map(fn($x) => intval($x), $row)
      ),
      $img
    )
  );
}

$data = preg_split("/\r?\n/", trim(image2bin($input)));

$algo = "";
$rest = false;
$img = [];
foreach ($data as $line) {
  if (empty($line)) $rest = true;
  else if (!$rest) {
    $algo .= $line;
  }
  else {
    $row = [];
    foreach (str_split($line) as $char) {
      array_push($row, $char);
    }
    array_push($img, $row);
  }
}

function solvePart1($algo, $img, $loops) {
  // echo "Loop nr zero\n-------------\n";
  // echo "\n" . printimg($img) . "\n";

  for ($loop = 0; $loop < $loops; $loop++) {
    $miny = min(array_keys($img)) - 1;
    $maxy = max(array_keys($img)) + 2;
    $minx = min(array_keys($img[0])) - 1;
    $maxx = max(array_keys($img[0])) + 2;
    
    // echo "Loop nr $loop\n-------------\n";

    $newimg = [];
    for ($y = $miny; $y < $maxy; $y++) {
      for ($x = $minx; $x < $maxx; $x++) {

        $pattern = "";

        if (array_key_exists($y-1, $img) && array_key_exists($x-1, $img[$y-1])) $pattern .= $img[$y-1][$x-1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y-1, $img) && array_key_exists($x  , $img[$y-1])) $pattern .= $img[$y-1][$x  ]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y-1, $img) && array_key_exists($x+1, $img[$y-1])) $pattern .= $img[$y-1][$x+1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y  , $img) && array_key_exists($x-1, $img[$y  ])) $pattern .= $img[$y  ][$x-1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y  , $img) && array_key_exists($x  , $img[$y  ])) $pattern .= $img[$y  ][$x  ]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y  , $img) && array_key_exists($x+1, $img[$y  ])) $pattern .= $img[$y  ][$x+1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y+1, $img) && array_key_exists($x-1, $img[$y+1])) $pattern .= $img[$y+1][$x-1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y+1, $img) && array_key_exists($x  , $img[$y+1])) $pattern .= $img[$y+1][$x  ]; else $pattern .= $loop % 2 === 0 ? "0" : "1";
        if (array_key_exists($y+1, $img) && array_key_exists($x+1, $img[$y+1])) $pattern .= $img[$y+1][$x+1]; else $pattern .= $loop % 2 === 0 ? "0" : "1";

        // echo "Pattern: $pattern for y=$y and x=$x\n";
        $number = bindec($pattern);
        $newchar = substr($algo, $number, 1);

        if (!array_key_exists($y, $newimg)) $newimg[$y] = [];
        $newimg[$y][$x] = $newchar;
        
      }
    }
    // echo "\n" . printimg($newimg) . "\n";
    $img = $newimg;
  }

  return lit($img);
}

echo "Solution 1: " . solvePart1($algo, $img, 2) . "\n";
echo "Solution 2: " . solvePart1($algo, $img, 50) . "\n";
